@using MudBlazor
@using System.Globalization
@inherits BlazorBusyComponentBaseModel

<style>
    .links-for-files-messages i > u {
        cursor: pointer;
    }

    #tg-chats-table td.mud-table-cell {
        border-bottom: none;
    }
</style>

@if (CurrentChat is null)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate Class="my-7" />
}
else
{
    <MudTable @ref="TableRef" ServerData="ServerReload" Dense Hover id="tg-chats-table">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Сообщения (Telegram)</MudText>
            <MudSpacer />
            <MudTextField Immediate
                          @bind-Value="SearchStringQuery"
                          Placeholder="Поиск по тексту"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel InitialDirection="SortDirection.Descending"
                                   SortLabel="@(nameof(MessageTelegramStandardModel.CreatedAtUtc))"
                                   T="MessageTelegramStandardModel"></MudTableSortLabel>
            </MudTh>
            <MudTh></MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudChat ChatPosition="@(CurrentChat.ChatTelegramId == context.From?.UserTelegramId ? ChatBubblePosition.Start : ChatBubblePosition.End)">
                    <MudChatHeader Name="@context.From?.GetName()"
                                   Time="@($"{context.CreatedAtUtc.GetCustomTime().ToString("d", GlobalStaticConstants.RU)} {@context.CreatedAtUtc.GetCustomTime().ToString("t", GlobalStaticConstants.RU)}")" />
                    <MudChatBubble>
                        @context.Text
                    </MudChatBubble>
                </MudChat>
            </MudTd>
            <MudTd>
                @context.Caption
                @if (context.Contact is not null)
                {
                    <span class="badge text-bg-primary">
                        @context.Contact.FirstName |
                        @context.Contact.LastName |
                        @context.Contact.PhoneNumber |
                        @context.Contact.Vcard
                    </span>
                }
            </MudTd>
            <MudTd>
                <FilesForMessageComponent Message="context" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>Сообщения не найдены</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>Loading...</MudText>
        </LoadingContent>
        <PagerContent>
            <MudTablePager AllItemsText="Все сообщения" />
        </PagerContent>
    </MudTable>
}