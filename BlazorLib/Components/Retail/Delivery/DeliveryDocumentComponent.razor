@using static SharedLib.GlobalStaticConstantsRoutes
@using BlazorLib.Components.Kladr.control.input
@using BlazorLib.Components.Retail.OrdersLinks
@using BlazorLib.Components.Retail.Orders
@using BlazorLib.Components.Telegram
@using BlazorLib.Components.TraceHistoryView
@using MudBlazor

@inherits BlazorBusyComponentBaseAuthModel

<MudCard>
    <MudCardContent>
        @if (IsBusyProgress || editDoc is null)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate Class="my-3" />
        }
        else
        {
            @if (editDoc.Id > 0 && totalWeightOrdersDocumentsLinks != editDoc.WeightShipping)
            {
                <div class="alert alert-warning" role="alert">
                    Вес отправления [@(editDoc.WeightShipping)] не совпадает с суммой весов заказов [@totalWeightOrdersDocumentsLinks]!
                    <hr />
                    [разница: @(editDoc.WeightShipping - totalWeightOrdersDocumentsLinks)]
                </div>
            }
            <MudGrid>
                <MudItem xs="6" sm="6" md="6" lg="2">
                    <div class="mb-3">
                        <label for="exampleInputWeightShipping" class="form-label">Вес (кг)</label>
                        <input type="number" class="form-control" id="exampleInputWeightShipping" @bind-value="editDoc.WeightShipping" @bind-value:event="oninput">
                    </div>
                </MudItem>
                <MudItem xs="6" sm="6" md="6" lg="1">
                    <div class="mb-3">
                        <label for="exampleInputShippingCost" class="form-label">Стоимость</label>
                        <input type="number" class="form-control" id="exampleInputShippingCost" @bind-value="editDoc.ShippingCost" @bind-value:event="oninput">
                    </div>
                </MudItem>
                <MudItem xs="6" sm="6" md="6" lg="3">
                    <div class="mb-3">
                        <label for="exampleInputPackageSize" class="form-label">Габариты</label>
                        <input type="text" class="form-control" id="exampleInputPackageSize" @bind-value="editDoc.PackageSize" @bind-value:event="oninput">
                    </div>
                </MudItem>
                <MudItem xs="6" sm="6" md="6" lg="3">
                    <div class="mb-3">
                        <label for="exampleInputDeliveryCode" class="form-label">Трек-код</label>
                        <input type="text" class="form-control" id="exampleInputDeliveryCode" @bind-value="editDoc.DeliveryCode" @bind-value:event="oninput">
                    </div>
                </MudItem>
                <MudItem xs="12" sm="12" md="12" lg="3">
                    <div class="mb-3">
                        <label for="exampleInputName" class="form-label">Примечание</label>
                        <input type="text" class="form-control" id="exampleInputName" @bind-value="editDoc.Name" @bind-value:event="oninput">
                    </div>
                </MudItem>

                <MudItem xs="12">
                    <div class="mb-3">
                        <label for="exampleInputNotes" class="form-label">Описание</label>
                        <input type="text" class="form-control" id="exampleInputNotes" @bind-value="editDoc.Notes" @bind-value:event="oninput">
                    </div>
                </MudItem>
                <MudItem xs="12" md=6 Class="mb-3">
                    <RubricInputComponent SelectRubricsHandle="WarehouseSelectAction"
                                          ModeSelectingRubrics=ModesSelectRubricsEnum.SelectAny
                                          RubricInitial="@editDoc.WarehouseId"
                                          Title="Склад отгрузки"
                                          ContextName="@Routes.WAREHOUSE_CONTROLLER_NAME"
                                          ShowDisabledRubrics />
                </MudItem>
                <MudItem xs="12" md=6 Class="mb-3">
                    <label for="exampleInputTypePayment" class="form-label">Тип/способ доставки</label>
                    <select class="form-select" id="exampleInputTypePayment" @bind="editDoc.DeliveryTypeId">
                        @foreach (UniversalBaseModel _pt in AllDeliveriesTypes)
                        {
                            <option value="@_pt">@_pt.Name</option>
                        }
                    </select>
                </MudItem>
            </MudGrid>

            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="switchCheckDefault" @bind="editDoc.DeliveryPaymentUponReceipt">
                <label class="form-check-label" for="switchCheckDefault">Оплата при получении</label>
            </div>
            <div class="mb-3">
                @if (string.IsNullOrWhiteSpace(ClientId))
                {
                    <UserSelectInputComponent SelectHandleAction="SelectUserHandler"
                                              SelectedUserInit="@editDoc.RecipientIdentityUserId"
                                              IsReadOnly="IsBusyProgress"
                                              Label="Получатель" />
                }
                else
                {
                    <div>
                        <label for="formControlInputBuyer" class="form-label">Покупатель</label>
                        <input class="form-control"
                               type="text"
                               value="@recipientUser?.ToString()"
                               aria-label="readonly input example"
                               readonly
                               id="formControlInputBuyer"
                               aria-describedby="buyerHelp">
                        <div id="buyerHelp" class="form-text">Контекст заказчика.</div>
                    </div>

                }
            </div>
            <div class="card my-3">
                <div class="card-body">
                    @if (CanCopyAddressFromRecipient)
                    {
                        <div class="d-grid gap-2 mb-2">
                            <button @onclick=SetDeliveryAddressFromUserRecipient
                                    class="btn btn-primary btn-sm"
                                    type="button">
                                Установить адрес получателя
                            </button>
                        </div>
                    }
                    <KladrInputComponent @bind-KladrObject="DeliveryAddressSelectedKladrObject" />
                    <div class="mb-3">
                        <label for="detailsAddressControlTextarea" class="form-label">уточнение адреса (если требуется)</label>
                        <textarea disabled="@IsBusyProgress" class="form-control" id="detailsAddressControlTextarea" rows="3" @oninput="AddressUserCommentHandleOnChange">@editDoc.AddressUserComment</textarea>
                    </div>
                </div>
            </div>

            @if (DeliveryDocumentId > 0)
            {
                <MudTabs Elevation="2" Rounded ApplyEffectsToContainer PanelClass="pa-2">
                    <MudTabPanel Text="Номенклатура">
                        <DeliveryTableRowsRetailComponent ForceAdding Document="editDoc" @ref=tableRowsRef />
                    </MudTabPanel>
                    <MudTabPanel Text="Заказы">
                        <OrdersDeliveriesLinksTableComponent DeliveryId="DeliveryDocumentId" ReloadOrdersLinks="ReloadDeliveriesOrdersLinksAction" />
                    </MudTabPanel>
                    <MudTabPanel Text="Статусы">
                        <DeliveryStatusesTableComponent Document="editDoc" />
                    </MudTabPanel>
                    <MudTabPanel Text="Заметки">
                        <TinyMCE.Blazor.Editor @bind-Value="editDoc.Description"
                                               Disable="IsBusyProgress"
                                               ScriptSrc="@GlobalStaticConstants.TinyMCEditorScriptSrc"
                                               Conf="@editorConf" />
                    </MudTabPanel>
                    @if (currentChatTelegram is not null)
                    {
                        <MudTabPanel Text="Telegram">
                            <TelegramChatWrapComponent Chat="currentChatTelegram" />
                        </MudTabPanel>
                    }
                    @if (DeliveryDocumentId > 0)
                    {
                        <AuthorizeView Context="col" Roles="@($"{GlobalStaticConstantsRoles.Roles.Admin}")">
                            <Authorized>
                                <MudTabPanel Text="История" Icon="@Icons.Material.Filled.BugReport">
                                    <HistoryDeliveriesWrapperComponent DeliveryId="DeliveryDocumentId" />
                                </MudTabPanel>
                            </Authorized>
                        </AuthorizeView>
                    }
                </MudTabs>

                <p class="card-text mt-2">
                    <small class="text-body-secondary">@editDoc.CreatedAtUTC.GetCustomTime() @editDoc.LastUpdatedAtUTC?.GetCustomTime()</small>
                </p>
            }

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                <button disabled="@CannotSave" class="btn btn-primary" type="button" @onclick=SaveDoc>
                    @(editDoc.Id <= 0 ? "Создать" : "Сохранить")
                </button>
                @if (!CannotSave)
                {
                    <button disabled="@CannotSave" class="btn btn-secondary" type="button" @onclick=ResetEdit>
                        Сброс
                    </button>
                }
            </div>
        }
    </MudCardContent>
</MudCard>